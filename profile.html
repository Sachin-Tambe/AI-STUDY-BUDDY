<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="profile.css">
</head>
<body>
  <div class="profile-card">
    <img id="avatar" class="avatar" src="https://via.placeholder.com/100" alt="Avatar">
    <h2 id="name">Loading...</h2>
    <p id="email"></p>
    <div class="streak">
      <span id="streak-count">0</span> day streak ðŸ”¥
    </div>
    <div class="last-login">
      Last login: <span id="last-login-date"></span>
    </div>
    <button id="logout">Sign Out</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase setup with environment variables
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
    const supabase = createClient(supabaseUrl, supabaseKey);

    // DOM elements
    const nameEl = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const avatarEl = document.getElementById('avatar');
    const streakCountEl = document.getElementById('streak-count');
    const lastLoginDateEl = document.getElementById('last-login-date');
    const logoutBtn = document.getElementById('logout');

    // Avatar error handler: Use fallback if avatar fails
    avatarEl.onerror = () => {
      const userName = nameEl.textContent || 'User';
      console.error("Avatar failed to load. Using fallback avatar.");
      avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random`;
    };

    // Load profile data
    async function loadProfile() {
      try {
        // Ensure session is detected
        const { data: session, error: sessionError } = await supabase.auth.getSession();
        if (sessionError || !session?.user) {
          console.error("No session detected:", sessionError);
          window.location.href = '/index.html';
          return;
        }

        const user = session.user;
        console.log("User:", user);

        // Set name and email
        const displayName = user.user_metadata?.name || user.email || 'User';
        nameEl.textContent = displayName;
        emailEl.textContent = user.email;

        // Set avatar - priority: Google identity picture > metadata > fallback
        const identities = user.identities || [];
        const googleAvatar = identities[0]?.identity_data?.picture;
        const metadataAvatar = user.user_metadata?.picture;

        if (googleAvatar) {
          avatarEl.src = googleAvatar;
        } else if (metadataAvatar) {
          avatarEl.src = metadataAvatar;
        } else {
          avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random`;
        }

        // Streak logic
        const currentDayLogin = new Date().toISOString().split('T')[0];
        const { data: userData, error: userDataError } = await supabase
          .from('User_Data')
          .select('*')
          .eq('id', user.id)
          .single();

        if (userDataError || !userData) {
          // First-time login, insert new streak record
          await supabase.from('User_Data').insert([{
            id: user.id,
            streak: 1,
            last_login: currentDayLogin,
            current_day_login: currentDayLogin
          }]);
          streakCountEl.textContent = 1;
          lastLoginDateEl.textContent = currentDayLogin;
          return;
        }

        // Calculate streak
        const lastLogin = userData.last_login;
        const daysDiff = Math.floor((new Date(currentDayLogin) - new Date(lastLogin)) / 86400000);
        let newStreak = userData.streak;

        if (daysDiff === 1) {
          newStreak += 1; // Continue streak
        } else if (daysDiff > 1) {
          newStreak = 1; // Reset streak
        }

        if (daysDiff !== 0) {
          await supabase.from('User_Data').update({
            streak: newStreak,
            last_login: currentDayLogin,
            current_day_login: currentDayLogin
          }).eq('id', user.id);
        }

        streakCountEl.textContent = newStreak;
        lastLoginDateEl.textContent = currentDayLogin;

      } catch (error) {
        console.error("Error:", error);
        alert(`Error: ${error.message}`);
      }
    }

    // Logout button
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/index.html';
    });

    // Load profile data on page load
    loadProfile();
  </script>
</body>
</html>
